<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed Core - WebSocket Client</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #58a6ff; margin-bottom: 20px; }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-connect { background: #238636; color: white; }
        .btn-connect:hover { background: #2ea043; }
        .btn-disconnect { background: #da3633; color: white; }
        .btn-disconnect:hover { background: #f85149; }
        .btn-clear { background: #30363d; color: #c9d1d9; }
        .btn-clear:hover { background: #484f58; }
        
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.connected { background: #238636; color: white; }
        .status.disconnected { background: #da3633; color: white; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        .stat-label { font-size: 12px; color: #8b949e; }
        .stat-value { font-size: 24px; font-weight: 600; color: #58a6ff; }
        
        .symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .symbol-card {
            background: #161b22;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            min-width: 200px;
        }
        .symbol-name { font-weight: 600; color: #58a6ff; margin-bottom: 5px; }
        .symbol-price { font-size: 20px; font-weight: 600; }
        .symbol-price.up { color: #3fb950; }
        .symbol-price.down { color: #f85149; }
        .symbol-details { font-size: 12px; color: #8b949e; margin-top: 5px; }
        
        .log-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            height: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            padding: 10px 15px;
            background: #21262d;
            border-bottom: 1px solid #30363d;
            font-weight: 600;
        }
        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            background: #0d1117;
            word-break: break-all;
        }
        .log-entry.crypto { border-left: 3px solid #f7931a; }
        .log-entry.forex { border-left: 3px solid #3fb950; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Feed Core - WebSocket Client</h1>
        
        <div class="controls">
            <button class="btn-connect" onclick="connect()">Connect</button>
            <button class="btn-disconnect" onclick="disconnect()">Disconnect</button>
            <button class="btn-clear" onclick="clearLog()">Clear Log</button>
            <span id="status" class="status disconnected">Disconnected</span>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Ticks</div>
                <div class="stat-value" id="tickCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ticks/sec</div>
                <div class="stat-value" id="tickRate">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Symbols</div>
                <div class="stat-value" id="symbolCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Connected</div>
                <div class="stat-value" id="connectedTime">--</div>
            </div>
        </div>
        
        <div class="symbols" id="symbolCards"></div>
        
        <div class="log-container">
            <div class="log-header">Live Tick Feed</div>
            <div class="log-content" id="log"></div>
        </div>
    </div>

    <script>
        const WS_URL = 'ws://5.75.180.24:8080/ws';
        
        let ws = null;
        let tickCount = 0;
        let lastTickCount = 0;
        let connectedAt = null;
        let symbols = {};
        let previousPrices = {};
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Already connected', 'system');
                return;
            }
            
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = 'Connected';
                    connectedAt = Date.now();
                    addLog('Connected to ' + WS_URL, 'system');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const tick = JSON.parse(event.data);
                        handleTick(tick);
                    } catch (e) {
                        addLog('Parse error: ' + event.data, 'system');
                    }
                };
                
                ws.onclose = () => {
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = 'Disconnected';
                    addLog('Disconnected', 'system');
                };
                
                ws.onerror = (error) => {
                    addLog('Error: ' + error.message, 'system');
                };
            } catch (e) {
                addLog('Connection failed: ' + e.message, 'system');
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function handleTick(tick) {
            tickCount++;
            document.getElementById('tickCount').textContent = tickCount.toLocaleString();
            
            const symbol = tick.s;
            if (!symbol) return;
            
            // Determine price (quote or OHLC)
            const price = tick.p || tick.C || 0;
            const isUp = previousPrices[symbol] ? price >= previousPrices[symbol] : true;
            previousPrices[symbol] = price;
            
            // Update symbol tracking
            if (!symbols[symbol]) {
                symbols[symbol] = { count: 0, type: tick.ty };
                document.getElementById('symbolCount').textContent = Object.keys(symbols).length;
            }
            symbols[symbol].count++;
            symbols[symbol].price = price;
            symbols[symbol].bid = tick.b;
            symbols[symbol].ask = tick.a;
            symbols[symbol].isUp = isUp;
            
            // Update symbol cards
            updateSymbolCard(symbol, symbols[symbol]);
            
            // Add to log
            const logClass = tick.ty === 'CRYPTO' ? 'crypto' : 'forex';
            addLog(JSON.stringify(tick), logClass);
        }
        
        function updateSymbolCard(symbol, data) {
            let card = document.getElementById('card-' + symbol);
            if (!card) {
                card = document.createElement('div');
                card.id = 'card-' + symbol;
                card.className = 'symbol-card';
                document.getElementById('symbolCards').appendChild(card);
            }
            
            const priceClass = data.isUp ? 'up' : 'down';
            const priceStr = data.price ? '$' + data.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
            
            card.innerHTML = `
                <div class="symbol-name">${symbol} <span style="font-size:10px;color:#8b949e">${data.type}</span></div>
                <div class="symbol-price ${priceClass}">${priceStr}</div>
                <div class="symbol-details">
                    Bid: ${data.bid || '--'} | Ask: ${data.ask || '--'} | Ticks: ${data.count.toLocaleString()}
                </div>
            `;
        }
        
        function addLog(message, type) {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 200 entries
            while (log.children.length > 200) {
                log.removeChild(log.lastChild);
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            tickCount = 0;
            symbols = {};
            previousPrices = {};
            document.getElementById('tickCount').textContent = '0';
            document.getElementById('symbolCount').textContent = '0';
            document.getElementById('symbolCards').innerHTML = '';
        }
        
        // Update tick rate every second
        setInterval(() => {
            const rate = tickCount - lastTickCount;
            lastTickCount = tickCount;
            document.getElementById('tickRate').textContent = rate.toLocaleString();
            
            if (connectedAt && ws && ws.readyState === WebSocket.OPEN) {
                const seconds = Math.floor((Date.now() - connectedAt) / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('connectedTime').textContent = mins + 'm ' + secs + 's';
            }
        }, 1000);
    </script>
</body>
</html>
